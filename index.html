<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>傻瓜劇團音效管理系統</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { margin: 0; padding: 0; }
  #root { min-height: 100vh; }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;

const DB_NAME = 'TheaterAppDB';
const DB_VERSION = 5;
const STORE_NAME = 'projects';
const MEDIA_STORE_NAME = 'mediaLibrary';

let dbInstance = null;

const initDB = () => {
  if (dbInstance) return Promise.resolve(dbInstance);
  
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      dbInstance = request.result;
      resolve(dbInstance);
    };
    
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains(MEDIA_STORE_NAME)) {
        db.createObjectStore(MEDIA_STORE_NAME, { keyPath: 'id' });
      }
    };
  });
};

const saveProjectsToDB = async (projects) => {
  try {
    const db = await initDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      store.clear();
      projects.forEach(p => store.add(p));
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  } catch (error) {
    console.error('保存失敗:', error);
  }
};

const loadProjectsFromDB = async () => {
  try {
    const db = await initDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result || []);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('載入失敗:', error);
    return [];
  }
};

function TheaterApp() {
  const [projects, setProjects] = useState([]);
  const [mediaLibrary, setMediaLibrary] = useState([]);
  const [currentProjectId, setCurrentProjectId] = useState(null);
  const [currentPage, setCurrentPage] = useState('projects');
  const [newProjectName, setNewProjectName] = useState('');
  const [newChapterName, setNewChapterName] = useState('');
  const [newSectionName, setNewSectionName] = useState('');
  const [newChapterId, setNewChapterId] = useState(null);
  const [currentPlayingId, setCurrentPlayingId] = useState(null);
  const [isPaused, setIsPaused] = useState(false);
  const [volume, setVolume] = useState(1);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [showMediaSelector, setShowMediaSelector] = useState(false);
  const [selectingForSection, setSelectingForSection] = useState(null);
  const audioRef = useRef(null);

  useEffect(() => {
    const loadData = async () => {
      const savedProjects = await loadProjectsFromDB();
      setProjects(savedProjects);
    };
    loadData();
  }, []);

  useEffect(() => {
    if (projects.length >= 0) {
      saveProjectsToDB(projects);
    }
  }, [projects]);

  const currentProject = projects.find(p => p.id === currentProjectId);

  const addProject = () => {
    if (!newProjectName.trim()) return;
    setProjects([...projects, { id: Date.now(), name: newProjectName, chapters: [] }]);
    setNewProjectName('');
  };

  const moveProject = (index, direction) => {
    const newProjects = [...projects];
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= newProjects.length) return;
    [newProjects[index], newProjects[newIndex]] = [newProjects[newIndex], newProjects[index]];
    setProjects(newProjects);
  };

  const duplicateProject = (projectToDuplicate) => {
    const baseName = projectToDuplicate.name;
    let copyNumber = 1;
    let newName = `${baseName} (複製 ${copyNumber})`;
    while (projects.some(p => p.name === newName)) {
      copyNumber++;
      newName = `${baseName} (複製 ${copyNumber})`;
    }
    const newProject = {
      id: Date.now(),
      name: newName,
      chapters: projectToDuplicate.chapters.map(chapter => ({
        ...chapter,
        id: Date.now() + Math.random(),
        sections: chapter.sections.map(section => ({ ...section, id: Date.now() + Math.random() }))
      }))
    };
    setProjects([...projects, newProject]);
  };

  const moveChapter = (index, direction) => {
    const chapters = [...currentProject.chapters];
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= chapters.length) return;
    [chapters[index], chapters[newIndex]] = [chapters[newIndex], chapters[index]];
    setProjects(projects.map(p => p.id === currentProjectId ? { ...currentProject, chapters } : p));
  };

  const moveSection = (chapterId, index, direction) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c => {
        if (c.id === chapterId) {
          const sections = [...c.sections];
          const newIndex = direction === 'up' ? index - 1 : index + 1;
          if (newIndex < 0 || newIndex >= sections.length) return c;
          [sections[index], sections[newIndex]] = [sections[newIndex], sections[index]];
          return { ...c, sections };
        }
        return c;
      })
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const addChapter = () => {
    if (!newChapterName.trim() || !currentProject) return;
    const updatedProject = {
      ...currentProject,
      chapters: [...currentProject.chapters, { id: Date.now(), name: newChapterName, sections: [] }]
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setNewChapterName('');
  };

  const deleteChapter = (chapterId) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.filter(c => c.id !== chapterId)
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const addSection = (chapterId) => {
    if (!newSectionName.trim() || !currentProject) return;
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { ...c, sections: [...c.sections, { id: Date.now(), name: newSectionName, cue: '', audioFile: null, audioData: null }] }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setNewSectionName('');
    setNewChapterId(null);
  };

  const deleteSection = (chapterId, sectionId) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId ? { ...c, sections: c.sections.filter(s => s.id !== sectionId) } : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const updateSectionCue = (chapterId, sectionId, cue) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { ...c, sections: c.sections.map(s => s.id === sectionId ? { ...s, cue } : s) }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const handleAudioUpload = (chapterId, sectionId, file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      const updatedProject = {
        ...currentProject,
        chapters: currentProject.chapters.map(c =>
          c.id === chapterId
            ? { ...c, sections: c.sections.map(s => s.id === sectionId ? { ...s, audioFile: file.name, audioData: dataUrl } : s) }
            : c
        )
      };
      setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    };
    reader.readAsDataURL(file);
  };

  const addMediaToLibrary = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      const newMedia = {
        id: Date.now(),
        name: file.name,
        audioData: dataUrl,
        uploadDate: new Date().toISOString()
      };
      setMediaLibrary([...mediaLibrary, newMedia]);
    };
    reader.readAsDataURL(file);
  };

  const deleteMediaFromLibrary = (mediaId) => {
    if (window.confirm('確定要刪除此音檔嗎?')) {
      setMediaLibrary(mediaLibrary.filter(m => m.id !== mediaId));
    }
  };

  const selectMediaForSection = (chapterId, sectionId, media) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { 
              ...c, 
              sections: c.sections.map(s => 
                s.id === sectionId 
                  ? { ...s, audioFile: media.name, audioData: media.audioData, mediaId: media.id } 
                  : s
              ) 
            }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setShowMediaSelector(false);
    setSelectingForSection(null);
  };

  const togglePlaySection = (section, sectionId) => {
    if (!section.audioData) return;
    
    if (currentPlayingId === sectionId && audioRef.current && !audioRef.current.paused) {
      audioRef.current.pause();
      setIsPaused(true);
      return;
    }
    
    if (currentPlayingId === sectionId && isPaused && audioRef.current) {
      audioRef.current.play();
      setIsPaused(false);
      return;
    }
    
    if (audioRef.current) {
      audioRef.current.src = section.audioData;
      audioRef.current.load();
      audioRef.current.play();
      setCurrentPlayingId(sectionId);
      setIsPaused(false);
    }
  };

  // 媒體庫頁面
  if (currentPage === 'media') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-4xl mx-auto">
          <button onClick={() => setCurrentPage('projects')} className="text-blue-600 hover:text-blue-700 font-semibold mb-6">← 回到專案列表</button>
          
          <h1 className="text-3xl font-bold text-slate-800 mb-6">🎵 媒體資料庫</h1>

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <label className="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-lg p-8 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
              <input
                type="file"
                accept="audio/*"
                onChange={(e) => {
                  if (e.target.files?.[0]) {
                    addMediaToLibrary(e.target.files[0]);
                    e.target.value = '';
                  }
                }}
                className="hidden"
              />
              <svg className="w-12 h-12 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p className="text-slate-600 font-medium">點擊上傳音檔</p>
            </label>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {mediaLibrary.map(media => (
              <div key={media.id} className="bg-white rounded-lg shadow-sm p-4 flex items-start gap-3">
                <div className="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                  <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                  </svg>
                </div>
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-slate-800 truncate">{media.name}</p>
                  <p className="text-xs text-slate-500">{new Date(media.uploadDate).toLocaleDateString('zh-TW')}</p>
                </div>
                <button
                  onClick={() => deleteMediaFromLibrary(media.id)}
                  className="flex-shrink-0 p-2 text-red-600 hover:bg-red-50 rounded-lg"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            ))}
          </div>

          {mediaLibrary.length === 0 && (
            <div className="text-center text-slate-400 py-12 bg-white rounded-lg">
              <p>媒體庫是空的</p>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 專案列表頁面
  if (currentPage === 'projects') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-2xl mx-auto">
          <div className="flex items-center justify-between mb-8">
            <div>
              <h1 className="text-4xl font-bold text-slate-800">傻瓜劇團音效管理系統</h1>
              <p className="text-xs text-slate-500 mt-1">🔥 本地儲存</p>
            </div>
            <button
              onClick={() => setCurrentPage('media')}
              className="flex flex-col items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
              </svg>
              <span className="text-[10px] mt-1">媒體庫</span>
            </button>
          </div>
          
          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div className="flex gap-2">
              <input
                type="text"
                value={newProjectName}
                onChange={(e) => setNewProjectName(e.target.value)}
                placeholder="輸入新專案名稱..."
                className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                onKeyPress={(e) => e.key === 'Enter' && addProject()}
              />
              <button onClick={addProject} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 whitespace-nowrap">
                ➕ 新增
              </button>
            </div>
          </div>

          <div className="space-y-3">
            {projects.map((p, idx) => (
              <div key={p.id} className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition">
                <div className="mb-3">
                  <h3 className="font-semibold text-slate-800 text-lg">{p.name}</h3>
                  <p className="text-sm text-slate-500">{p.chapters.length} 幕</p>
                </div>
                <div className="grid grid-cols-3 sm:flex sm:flex-wrap gap-2">
                  <button 
                    onClick={() => { setCurrentProjectId(p.id); setCurrentPage('play'); }} 
                    className="flex flex-col items-center justify-center p-2 text-green-600 hover:bg-green-50 rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span className="text-[10px]">進入專案</span>
                  </button>
                  <button 
                    onClick={() => { setCurrentProjectId(p.id); setCurrentPage('settings'); }} 
                    className="flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span className="text-[10px]">編輯專案</span>
                  </button>
                  <button 
                    onClick={() => moveProject(idx, 'up')} 
                    disabled={idx === 0}
                    className="flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 15l7-7 7 7" />
                    </svg>
                    <span className="text-[10px]">上移</span>
                  </button>
                  <button 
                    onClick={() => moveProject(idx, 'down')} 
                    disabled={idx === projects.length - 1}
                    className="flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 9l-7 7-7-7" />
                    </svg>
                    <span className="text-[10px]">下移</span>
                  </button>
                  <button 
                    onClick={() => duplicateProject(p)} 
                    className="flex flex-col items-center justify-center p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <span className="text-[10px]">複製</span>
                  </button>
                  <button 
                    onClick={() => deleteProject(p.id)} 
                    className="flex flex-col items-center justify-center p-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                  >
                    <svg className="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span className="text-[10px]">刪除</span>
                  </button>
                </div>
              </div>
            ))}
          </div>

          {projects.length === 0 && (
            <div className="text-center text-slate-400 py-12 bg-white rounded-lg">
              <p>還沒有任何專案,新增一個開始吧!</p>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 編輯頁面
  if (currentPage === 'settings' && currentProject) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-4xl mx-auto">
          <button onClick={() => setCurrentPage('projects')} className="text-blue-600 hover:text-blue-700 font-semibold mb-6 text-sm md:text-base">← 回到專案列表</button>
          <h1 className="text-2xl md:text-3xl font-bold text-slate-800 mb-6 md:mb-8">{currentProject.name} - 設定</h1>

          <div className="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6 md:mb-8">
            <h2 className="text-lg md:text-xl font-semibold text-slate-800 mb-3 md:mb-4">新增章節</h2>
            <div className="flex flex-col sm:flex-row gap-2">
              <input
                type="text"
                value={newChapterName}
                onChange={(e) => setNewChapterName(e.target.value)}
                placeholder="例:第一幕..."
                className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base"
                onKeyPress={(e) => e.key === 'Enter' && addChapter()}
              />
              <button onClick={addChapter} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm md:text-base whitespace-nowrap">
                ➕ 新增章節
              </button>
            </div>
          </div>

          <div className="space-y-6">
            {currentProject.chapters.map((chapter, idx) => (
              <div key={chapter.id} className="bg-white rounded-lg shadow-sm p-4 md:p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-slate-800">{chapter.name}</h3>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => moveChapter(idx, 'up')} 
                      disabled={idx === 0}
                      className="p-2 text-slate-600 hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg transition"
                      title="上移"
                    >
                      ▲
                    </button>
                    <button 
                      onClick={() => moveChapter(idx, 'down')} 
                      disabled={idx === currentProject.chapters.length - 1}
                      className="p-2 text-slate-600 hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg transition"
                      title="下移"
                    >
                      ▼
                    </button>
                    <button onClick={() => deleteChapter(chapter.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="刪除">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                </div>

                {newChapterId === chapter.id ? (
                  <div className="mb-4 p-3 md:p-4 bg-slate-50 rounded-lg">
                    <input
                      type="text"
                      value={newSectionName}
                      onChange={(e) => setNewSectionName(e.target.value)}
                      placeholder="段落名稱..."
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base"
                      autoFocus
                    />
                    <div className="flex gap-2">
                      <button onClick={() => addSection(chapter.id)} className="bg-green-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">確認</button>
                      <button onClick={() => { setNewChapterId(null); setNewSectionName(''); }} className="bg-slate-300 text-slate-800 px-3 md:px-4 py-2 rounded-lg hover:bg-slate-400 transition text-sm">取消</button>
                    </div>
                  </div>
                ) : (
                  <button onClick={() => setNewChapterId(chapter.id)} className="mb-4 text-blue-600 hover:text-blue-700 font-semibold text-sm md:text-base">
                    ➕ 新增段落
                  </button>
                )}

                <div className="space-y-3">
                  {chapter.sections.map((section, sIdx) => (
                    <div key={section.id} className="border border-slate-200 rounded-lg p-4 bg-slate-50">
                      <div className="flex items-center justify-between mb-3">
                        <p className="font-medium text-slate-700">{section.name}</p>
                        <div className="flex gap-1">
                          <button 
                            onClick={() => moveSection(chapter.id, sIdx, 'up')} 
                            disabled={sIdx === 0}
                            className="p-1 text-slate-600 hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed rounded transition"
                            title="上移"
                          >
                            ▲
                          </button>
                          <button 
                            onClick={() => moveSection(chapter.id, sIdx, 'down')} 
                            disabled={sIdx === chapter.sections.length - 1}
                            className="p-1 text-slate-600 hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed rounded transition"
                            title="下移"
                          >
                            ▼
                          </button>
                          <button onClick={() => deleteSection(chapter.id, section.id)} className="p-1 text-red-600 hover:bg-red-50 rounded transition" title="刪除">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>
                        </div>
                      </div>
                      
                      <input
                        type="text"
                        value={section.cue}
                        onChange={(e) => updateSectionCue(chapter.id, section.id, e.target.value)}
                        placeholder="提示詞..."
                        className="w-full px-3 py-2 border border-slate-300 rounded mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />

                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <label className="flex items-center gap-2 cursor-pointer text-sm flex-1">
                            <input
                              type="file"
                              accept="audio/*"
                              onChange={(e) => {
                                if (e.target.files?.[0]) {
                                  handleAudioUpload(chapter.id, section.id, e.target.files[0]);
                                  e.target.value = '';
                                }
                              }}
                              className="hidden"
                            />
                            <span className="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded transition w-full text-center">
                              📁 本地上傳
                            </span>
                          </label>
                          <button
                            onClick={() => {
                              setSelectingForSection({ chapterId: chapter.id, sectionId: section.id });
                              setShowMediaSelector(true);
                            }}
                            className="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition text-sm flex items-center gap-1 flex-shrink-0"
                            title="從媒體庫選擇"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                            媒體庫
                          </button>
                        </div>
                        {section.audioFile && (
                          <div className="px-3 py-2 bg-green-50 border border-green-200 rounded text-sm text-green-700">
                            ✓ {section.audioFile}
                            {section.mediaId && <span className="ml-2 text-xs">(來自媒體庫)</span>}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        {showMediaSelector && selectingForSection && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
              <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                <h2 className="text-xl font-bold text-slate-800">從媒體庫選擇音檔</h2>
                <button
                  onClick={() => {
                    setShowMediaSelector(false);
                    setSelectingForSection(null);
                  }}
                  className="p-2 hover:bg-slate-100 rounded-lg transition"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="p-4 overflow-y-auto flex-1">
                {mediaLibrary.length === 0 ? (
                  <div className="text-center text-slate-400 py-12">
                    <p>媒體庫是空的</p>
                    <button
                      onClick={() => {
                        setShowMediaSelector(false);
                        setSelectingForSection(null);
                        setCurrentPage('media');
                      }}
                      className="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                    >
                      前往媒體庫上傳
                    </button>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 gap-3">
                    {mediaLibrary.map(media => (
                      <button
                        key={media.id}
                        onClick={() => selectMediaForSection(selectingForSection.chapterId, selectingForSection.sectionId, media)}
                        className="flex items-center gap-3 p-4 border-2 border-slate-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition text-left"
                      >
                        <div className="flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                          <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                          </svg>
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-slate-800 truncate">{media.name}</p>
                          <p className="text-xs text-slate-500">{new Date(media.uploadDate).toLocaleDateString('zh-TW')}</p>
                        </div>
                        <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // 播放頁面
  if (currentPage === 'play' && currentProject) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-5xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <button onClick={() => setCurrentPage('projects')} className="text-blue-600 hover:text-blue-700 font-semibold mb-2">← 回到專案列表</button>
              <h1 className="text-3xl font-bold text-slate-800">{currentProject.name}</h1>
            </div>
            <button 
              onClick={() => setCurrentPage('settings')} 
              className="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50"
            >
              ✏️ 編輯專案
            </button>
          </div>

          <div className="space-y-6 mb-20">
            {currentProject.chapters.map(chapter => (
              <div key={chapter.id} className="bg-white rounded-lg shadow-sm p-6">
                <h2 className="text-xl font-semibold mb-4">{chapter.name}</h2>
                <div className="space-y-3">
                  {chapter.sections.map(section => {
                    const isPlaying = currentPlayingId === section.id && !isPaused;
                    const isPausedState = currentPlayingId === section.id && isPaused;
                    return (
                      <div key={section.id} className={`border-2 rounded-lg p-4 transition ${isPlaying ? 'border-blue-500 bg-blue-50' : isPausedState ? 'border-yellow-500 bg-yellow-50' : 'border-slate-200'}`}>
                        <div className="flex items-start gap-3">
                          <button
                            onClick={() => togglePlaySection(section, section.id)}
                            disabled={!section.audioData}
                            className={`flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center ${
                              !section.audioData
                                ? 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                : isPlaying
                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                : isPausedState
                                ? 'bg-yellow-600 text-white hover:bg-yellow-700'
                                : 'bg-slate-700 text-white hover:bg-slate-800'
                            }`}
                          >
                            {isPlaying ? (
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                              </svg>
                            ) : (
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                              </svg>
                            )}
                          </button>
                          <div className="flex-1">
                            <p className="font-semibold text-slate-800 mb-1">{section.name}</p>
                            {section.cue && <p className="text-sm text-slate-600 mb-1">{section.cue}</p>}
                            <p className="text-xs text-slate-500">
                              {section.audioFile ? '🎵 ' + section.audioFile : '⚠️ 未上傳音檔'}
                            </p>
                            {(isPlaying || isPausedState) && (
                              <div className="mt-3 flex items-center gap-2">
                                <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full ${isPlaying ? 'bg-blue-600' : 'bg-yellow-600'}`}
                                    style={{ width: duration > 0 ? `${(currentTime / duration) * 100}%` : '0%', transition: 'width 0.1s' }} 
                                  />
                                </div>
                                <span className="text-xs text-slate-600 font-medium w-12 text-right">
                                  {Math.floor(currentTime)}s / {Math.floor(duration)}s
                                </span>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>

          {currentProject.chapters.length === 0 && (
            <div className="text-center text-slate-400 py-12 bg-white rounded-lg">
              <p>還沒有任何章節或段落</p>
              <button 
                onClick={() => setCurrentPage('settings')}
                className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                前往編輯
              </button>
            </div>
          )}

          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-lg">
            <div className="max-w-5xl mx-auto flex items-center gap-4">
              <svg className="w-5 h-5 text-slate-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
              </svg>
              <input
                type="range"
                min="0"
                max="1"
                step="0.01"
                value={volume}
                onChange={(e) => {
                  const newVol = parseFloat(e.target.value);
                  setVolume(newVol);
                  if (audioRef.current) audioRef.current.volume = newVol;
                }}
                className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${volume * 100}%, #e2e8f0 ${volume * 100}%, #e2e8f0 100%)`
                }}
              />
              <span className="text-sm text-slate-600 font-medium w-12 text-right">{Math.round(volume * 100)}%</span>
            </div>
          </div>
        </div>

        <audio
          ref={audioRef}
          onEnded={() => {
            setCurrentPlayingId(null);
            setIsPaused(false);
          }}
          onTimeUpdate={(e) => setCurrentTime(e.target.currentTime)}
          onLoadedMetadata={(e) => setDuration(e.target.duration)}
        />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
      <div className="text-center">
        <p className="text-slate-600">請選擇專案</p>
        <button onClick={() => setCurrentPage('projects')} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          回到專案列表
        </button>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<TheaterApp />);
</script>
</body>
</html>