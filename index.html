<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‚»ç“œåŠ‡åœ˜éŸ³æ•ˆç®¡ç†ç³»çµ± - é›²ç«¯ç‰ˆ</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
  body { margin: 0; padding: 0; }
  #root { min-height: 100vh; }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
  }
  .loading-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;

// ===== Firebase é…ç½® =====
// è«‹å°‡ä»¥ä¸‹é…ç½®æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½®
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// åˆå§‹åŒ– Firebase
let firebaseApp, db, storage;
try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  storage = firebase.storage();
  console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
  console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
}

// ===== Firebase æ“ä½œå‡½æ•¸ =====

// å„²å­˜å°ˆæ¡ˆåˆ° Firebase
const saveProjectsToFirebase = async (projects) => {
  try {
    await db.collection('theaterProjects').doc('mainData').set({
      projects: projects,
      lastUpdated: new Date().toISOString()
    });
    console.log('å°ˆæ¡ˆå·²å„²å­˜åˆ°é›²ç«¯');
    return true;
  } catch (error) {
    console.error('å„²å­˜åˆ°é›²ç«¯å¤±æ•—:', error);
    return false;
  }
};

// å¾ Firebase è¼‰å…¥å°ˆæ¡ˆ
const loadProjectsFromFirebase = async () => {
  try {
    const doc = await db.collection('theaterProjects').doc('mainData').get();
    if (doc.exists) {
      const data = doc.data();
      console.log('å¾é›²ç«¯è¼‰å…¥å°ˆæ¡ˆæˆåŠŸ');
      return data.projects || [];
    }
    return [];
  } catch (error) {
    console.error('å¾é›²ç«¯è¼‰å…¥å¤±æ•—:', error);
    return [];
  }
};

// ä¸Šå‚³éŸ³æª”åˆ° Firebase Storage
const uploadMediaToFirebase = async (file, onProgress) => {
  try {
    const fileId = `media_${Date.now()}_${file.name}`;
    const storageRef = storage.ref(`mediaLibrary/${fileId}`);
    const uploadTask = storageRef.put(file);

    return new Promise((resolve, reject) => {
      uploadTask.on(
        'state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          if (onProgress) onProgress(progress);
        },
        (error) => {
          console.error('ä¸Šå‚³å¤±æ•—:', error);
          reject(error);
        },
        async () => {
          const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
          resolve({
            id: fileId,
            name: file.name,
            url: downloadURL,
            size: file.size,
            type: file.type,
            uploadDate: new Date().toISOString()
          });
        }
      );
    });
  } catch (error) {
    console.error('ä¸Šå‚³åª’é«”å¤±æ•—:', error);
    throw error;
  }
};

// å„²å­˜åª’é«”åº«æ¸…å–®åˆ° Firebase
const saveMediaLibraryToFirebase = async (mediaLibrary) => {
  try {
    await db.collection('theaterProjects').doc('mediaLibrary').set({
      media: mediaLibrary,
      lastUpdated: new Date().toISOString()
    });
    console.log('åª’é«”åº«å·²æ›´æ–°åˆ°é›²ç«¯');
    return true;
  } catch (error) {
    console.error('å„²å­˜åª’é«”åº«å¤±æ•—:', error);
    return false;
  }
};

// å¾ Firebase è¼‰å…¥åª’é«”åº«
const loadMediaLibraryFromFirebase = async () => {
  try {
    const doc = await db.collection('theaterProjects').doc('mediaLibrary').get();
    if (doc.exists) {
      const data = doc.data();
      console.log('å¾é›²ç«¯è¼‰å…¥åª’é«”åº«æˆåŠŸ');
      return data.media || [];
    }
    return [];
  } catch (error) {
    console.error('å¾é›²ç«¯è¼‰å…¥åª’é«”åº«å¤±æ•—:', error);
    return [];
  }
};

// å¾ Firebase Storage åˆªé™¤åª’é«”æª”æ¡ˆ
const deleteMediaFromFirebase = async (fileId) => {
  try {
    const storageRef = storage.ref(`mediaLibrary/${fileId}`);
    await storageRef.delete();
    console.log('åª’é«”æª”æ¡ˆå·²å¾é›²ç«¯åˆªé™¤');
    return true;
  } catch (error) {
    console.error('åˆªé™¤åª’é«”æª”æ¡ˆå¤±æ•—:', error);
    return false;
  }
};

// ===== ä¸»è¦æ‡‰ç”¨ç¨‹å¼ =====

function TheaterApp() {
  const [projects, setProjects] = useState([]);
  const [mediaLibrary, setMediaLibrary] = useState([]);
  const [currentProjectId, setCurrentProjectId] = useState(null);
  const [currentPage, setCurrentPage] = useState('projects');
  const [newProjectName, setNewProjectName] = useState('');
  const [newChapterName, setNewChapterName] = useState('');
  const [newSectionName, setNewSectionName] = useState('');
  const [newChapterId, setNewChapterId] = useState(null);
  const [currentPlayingId, setCurrentPlayingId] = useState(null);
  const [isPaused, setIsPaused] = useState(false);
  const [volume, setVolume] = useState(1);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [showMediaSelector, setShowMediaSelector] = useState(false);
  const [selectingForSection, setSelectingForSection] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [isUploading, setIsUploading] = useState(false);
  const [syncStatus, setSyncStatus] = useState(''); // åŒæ­¥ç‹€æ…‹è¨Šæ¯
  const audioRef = useRef(null);
  const fileInputRef = useRef(null);

  // åˆå§‹è¼‰å…¥ï¼šå¾ Firebase è¼‰å…¥è³‡æ–™
  useEffect(() => {
    const loadData = async () => {
      setIsLoading(true);
      try {
        const [loadedProjects, loadedMedia] = await Promise.all([
          loadProjectsFromFirebase(),
          loadMediaLibraryFromFirebase()
        ]);
        setProjects(loadedProjects);
        setMediaLibrary(loadedMedia);
        setSyncStatus('âœ… å·²å¾é›²ç«¯è¼‰å…¥è³‡æ–™');
        setTimeout(() => setSyncStatus(''), 3000);
      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        setSyncStatus('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
      } finally {
        setIsLoading(false);
      }
    };
    loadData();
  }, []);

  const currentProject = projects.find(p => p.id === currentProjectId);

  // æ‰‹å‹•å„²å­˜åˆ°é›²ç«¯
  const saveToCloud = async () => {
    setIsSaving(true);
    setSyncStatus('â³ æ­£åœ¨å„²å­˜åˆ°é›²ç«¯...');
    try {
      const projectSuccess = await saveProjectsToFirebase(projects);
      const mediaSuccess = await saveMediaLibraryToFirebase(mediaLibrary);
      
      if (projectSuccess && mediaSuccess) {
        setSyncStatus('âœ… å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯');
      } else {
        setSyncStatus('âš ï¸ å„²å­˜æ™‚ç™¼ç”Ÿéƒ¨åˆ†éŒ¯èª¤');
      }
    } catch (error) {
      setSyncStatus('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
    } finally {
      setIsSaving(false);
      setTimeout(() => setSyncStatus(''), 3000);
    }
  };

  // å°ˆæ¡ˆç®¡ç†å‡½æ•¸
  const addProject = () => {
    if (!newProjectName.trim()) return;
    setProjects([...projects, { id: Date.now(), name: newProjectName, chapters: [] }]);
    setNewProjectName('');
  };

  const moveProject = (index, direction) => {
    const newProjects = [...projects];
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= newProjects.length) return;
    [newProjects[index], newProjects[newIndex]] = [newProjects[newIndex], newProjects[index]];
    setProjects(newProjects);
  };

  const duplicateProject = (projectToDuplicate) => {
    const baseName = projectToDuplicate.name;
    let copyNumber = 1;
    let newName = `${baseName} (è¤‡è£½ ${copyNumber})`;
    while (projects.some(p => p.name === newName)) {
      copyNumber++;
      newName = `${baseName} (è¤‡è£½ ${copyNumber})`;
    }
    const newProject = {
      id: Date.now(),
      name: newName,
      chapters: projectToDuplicate.chapters.map(chapter => ({
        ...chapter,
        id: Date.now() + Math.random(),
        sections: chapter.sections.map(section => ({ ...section, id: Date.now() + Math.random() }))
      }))
    };
    setProjects([...projects, newProject]);
  };

  const deleteProject = (projectId) => {
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—?')) {
      setProjects(projects.filter(p => p.id !== projectId));
    }
  };

  const moveChapter = (index, direction) => {
    const chapters = [...currentProject.chapters];
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= chapters.length) return;
    [chapters[index], chapters[newIndex]] = [chapters[newIndex], chapters[index]];
    setProjects(projects.map(p => p.id === currentProjectId ? { ...currentProject, chapters } : p));
  };

  const moveSection = (chapterId, index, direction) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c => {
        if (c.id === chapterId) {
          const sections = [...c.sections];
          const newIndex = direction === 'up' ? index - 1 : index + 1;
          if (newIndex < 0 || newIndex >= sections.length) return c;
          [sections[index], sections[newIndex]] = [sections[newIndex], sections[index]];
          return { ...c, sections };
        }
        return c;
      })
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const addChapter = () => {
    if (!newChapterName.trim()) return;
    const updatedProject = {
      ...currentProject,
      chapters: [...currentProject.chapters, { id: Date.now(), name: newChapterName, sections: [] }]
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setNewChapterName('');
  };

  const addSection = (chapterId) => {
    if (!newSectionName.trim()) return;
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { ...c, sections: [...c.sections, { id: Date.now(), name: newSectionName, cue: '', audioFile: '', audioData: null }] }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setNewSectionName('');
    setNewChapterId(null);
  };

  const deleteChapter = (chapterId) => {
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç« ç¯€å—?')) {
      const updatedProject = {
        ...currentProject,
        chapters: currentProject.chapters.filter(c => c.id !== chapterId)
      };
      setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    }
  };

  const deleteSection = (chapterId, sectionId) => {
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ®µè½å—?')) {
      const updatedProject = {
        ...currentProject,
        chapters: currentProject.chapters.map(c =>
          c.id === chapterId
            ? { ...c, sections: c.sections.filter(s => s.id !== sectionId) }
            : c
        )
      };
      setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    }
  };

  const updateSectionCue = (chapterId, sectionId, cue) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { ...c, sections: c.sections.map(s => s.id === sectionId ? { ...s, cue } : s) }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const updateChapterName = (chapterId, newName) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c => c.id === chapterId ? { ...c, name: newName } : c)
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  const updateSectionName = (chapterId, sectionId, newName) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? { ...c, sections: c.sections.map(s => s.id === sectionId ? { ...s, name: newName } : s) }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
  };

  // åª’é«”åº«ç®¡ç†
  const handleMediaUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setIsUploading(true);
    setUploadProgress(0);

    try {
      const uploadedMedia = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const mediaData = await uploadMediaToFirebase(file, (progress) => {
          setUploadProgress(((i + progress / 100) / files.length) * 100);
        });
        uploadedMedia.push(mediaData);
      }

      const newMediaLibrary = [...mediaLibrary, ...uploadedMedia];
      setMediaLibrary(newMediaLibrary);
      await saveMediaLibraryToFirebase(newMediaLibrary);
      
      setSyncStatus(`âœ… å·²ä¸Šå‚³ ${files.length} å€‹æª”æ¡ˆåˆ°é›²ç«¯`);
      setTimeout(() => setSyncStatus(''), 3000);
    } catch (error) {
      console.error('ä¸Šå‚³å¤±æ•—:', error);
      setSyncStatus('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
      setTimeout(() => setSyncStatus(''), 3000);
    } finally {
      setIsUploading(false);
      setUploadProgress(0);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const deleteMedia = async (mediaId) => {
    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åª’é«”æª”æ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

    try {
      await deleteMediaFromFirebase(mediaId);
      const newMediaLibrary = mediaLibrary.filter(m => m.id !== mediaId);
      setMediaLibrary(newMediaLibrary);
      await saveMediaLibraryToFirebase(newMediaLibrary);
      
      setSyncStatus('âœ… å·²åˆªé™¤åª’é«”æª”æ¡ˆ');
      setTimeout(() => setSyncStatus(''), 3000);
    } catch (error) {
      console.error('åˆªé™¤å¤±æ•—:', error);
      setSyncStatus('âŒ åˆªé™¤å¤±æ•—');
      setTimeout(() => setSyncStatus(''), 3000);
    }
  };

  const selectMediaForSection = (chapterId, sectionId, media) => {
    const updatedProject = {
      ...currentProject,
      chapters: currentProject.chapters.map(c =>
        c.id === chapterId
          ? {
              ...c,
              sections: c.sections.map(s =>
                s.id === sectionId
                  ? { ...s, audioFile: media.name, audioData: media.url }
                  : s
              )
            }
          : c
      )
    };
    setProjects(projects.map(p => p.id === currentProjectId ? updatedProject : p));
    setShowMediaSelector(false);
    setSelectingForSection(null);
  };

  const openMediaSelector = (chapterId, sectionId) => {
    setSelectingForSection({ chapterId, sectionId });
    setShowMediaSelector(true);
  };

  // æ’­æ”¾æ§åˆ¶
  const togglePlaySection = (section, sectionId) => {
    if (!section.audioData) return;

    if (currentPlayingId === sectionId) {
      if (isPaused) {
        audioRef.current.play();
        setIsPaused(false);
      } else {
        audioRef.current.pause();
        setIsPaused(true);
      }
    } else {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
      }
      setCurrentPlayingId(sectionId);
      setIsPaused(false);
      audioRef.current.src = section.audioData;
      audioRef.current.volume = volume;
      audioRef.current.play();
    }
  };

  // è¼‰å…¥ä¸­ç•«é¢
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
        <div className="text-center">
          <div className="loading-spinner mx-auto mb-4"></div>
          <p className="text-slate-600 font-medium">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è³‡æ–™...</p>
        </div>
      </div>
    );
  }

  // å°ˆæ¡ˆåˆ—è¡¨é é¢
  if (currentPage === 'projects') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4 md:p-8">
        <div className="max-w-4xl mx-auto">
          <div className="flex items-center justify-between mb-8">
            <h1 className="text-4xl font-bold text-slate-800">å‚»ç“œåŠ‡åœ˜éŸ³æ•ˆç®¡ç†ç³»çµ±</h1>
            <div className="flex gap-2">
              {syncStatus && (
                <div className="px-3 py-2 bg-white rounded-lg shadow-sm text-sm font-medium">
                  {syncStatus}
                </div>
              )}
              <button
                onClick={saveToCloud}
                disabled={isSaving}
                className={`px-4 py-2 rounded-lg font-semibold shadow-sm transition ${
                  isSaving
                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed'
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
              >
                {isSaving ? 'å„²å­˜ä¸­...' : 'ğŸ’¾ å„²å­˜åˆ°é›²ç«¯'}
              </button>
              <button
                onClick={() => setCurrentPage('media')}
                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-sm transition"
              >
                ğŸ“š åª’é«”åº«
              </button>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">æ–°å¢å°ˆæ¡ˆ</h2>
            <div className="flex gap-2">
              <input
                type="text"
                value={newProjectName}
                onChange={(e) => setNewProjectName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addProject()}
                placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±"
                className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={addProject}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition"
              >
                æ–°å¢
              </button>
            </div>
          </div>

          <div className="space-y-4">
            {projects.map((project, index) => (
              <div key={project.id} className="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition">
                <div className="flex items-center justify-between">
                  <h3 className="text-2xl font-bold text-slate-800">{project.name}</h3>
                  <div className="flex gap-2">
                    <button
                      onClick={() => moveProject(index, 'up')}
                      disabled={index === 0}
                      className={`px-3 py-1 rounded-lg ${index === 0 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                    >
                      â†‘
                    </button>
                    <button
                      onClick={() => moveProject(index, 'down')}
                      disabled={index === projects.length - 1}
                      className={`px-3 py-1 rounded-lg ${index === projects.length - 1 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                    >
                      â†“
                    </button>
                    <button
                      onClick={() => duplicateProject(project)}
                      className="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                      ğŸ“‹ è¤‡è£½
                    </button>
                    <button
                      onClick={() => {
                        setCurrentProjectId(project.id);
                        setCurrentPage('play');
                      }}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                      â–¶ï¸ æ’­æ”¾
                    </button>
                    <button
                      onClick={() => {
                        setCurrentProjectId(project.id);
                        setCurrentPage('settings');
                      }}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                    >
                      âœï¸ ç·¨è¼¯
                    </button>
                    <button
                      onClick={() => deleteProject(project.id)}
                      className="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
                <p className="text-slate-600 mt-2">
                  {project.chapters.length} å€‹ç« ç¯€ï¼Œ
                  {project.chapters.reduce((sum, ch) => sum + ch.sections.length, 0)} å€‹æ®µè½
                </p>
              </div>
            ))}
          </div>

          {projects.length === 0 && (
            <div className="text-center py-12 bg-white rounded-2xl shadow-lg">
              <p className="text-slate-400 text-lg">é‚„æ²’æœ‰ä»»ä½•å°ˆæ¡ˆï¼Œé–‹å§‹æ–°å¢ä¸€å€‹å§ï¼</p>
            </div>
          )}
        </div>
      </div>
    );
  }

  // åª’é«”åº«é é¢
  if (currentPage === 'media') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-4 md:p-8">
        <div className="max-w-6xl mx-auto">
          <div className="flex items-center justify-between mb-8">
            <div>
              <button onClick={() => setCurrentPage('projects')} className="text-purple-600 hover:text-purple-700 font-semibold mb-2">
                â† å›åˆ°å°ˆæ¡ˆåˆ—è¡¨
              </button>
              <h1 className="text-4xl font-bold text-slate-800">åª’é«”åº«</h1>
            </div>
            <div className="flex gap-2">
              {syncStatus && (
                <div className="px-3 py-2 bg-white rounded-lg shadow-sm text-sm font-medium">
                  {syncStatus}
                </div>
              )}
              <button
                onClick={() => fileInputRef.current?.click()}
                disabled={isUploading}
                className={`px-6 py-3 rounded-lg font-semibold shadow-sm transition ${
                  isUploading
                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed'
                    : 'bg-purple-600 text-white hover:bg-purple-700'
                }`}
              >
                {isUploading ? 'ä¸Šå‚³ä¸­...' : 'ğŸ“¤ ä¸Šå‚³åª’é«”æª”æ¡ˆ'}
              </button>
              <input
                ref={fileInputRef}
                type="file"
                accept="audio/*"
                multiple
                onChange={handleMediaUpload}
                className="hidden"
              />
            </div>
          </div>

          {isUploading && (
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
              <div className="flex items-center gap-4">
                <div className="flex-1">
                  <div className="h-4 bg-slate-200 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-purple-600 transition-all duration-300"
                      style={{ width: `${uploadProgress}%` }}
                    />
                  </div>
                </div>
                <span className="text-sm font-semibold text-slate-600">
                  {Math.round(uploadProgress)}%
                </span>
              </div>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {mediaLibrary.map(media => (
              <div key={media.id} className="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition">
                <div className="flex items-start gap-4">
                  <div className="flex-shrink-0 w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center">
                    <svg className="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-bold text-slate-800 truncate mb-1">{media.name}</p>
                    <p className="text-xs text-slate-500 mb-2">
                      {new Date(media.uploadDate).toLocaleDateString('zh-TW')}
                    </p>
                    <p className="text-xs text-slate-400">
                      {(media.size / 1024 / 1024).toFixed(2)} MB
                    </p>
                  </div>
                </div>
                <div className="mt-4 flex gap-2">
                  <a
                    href={media.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-center text-sm font-semibold"
                  >
                    é è¦½
                  </a>
                  <button
                    onClick={() => deleteMedia(media.id)}
                    className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-semibold"
                  >
                    åˆªé™¤
                  </button>
                </div>
              </div>
            ))}
          </div>

          {mediaLibrary.length === 0 && !isUploading && (
            <div className="text-center py-12 bg-white rounded-2xl shadow-lg">
              <svg className="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
              </svg>
              <p className="text-slate-400 text-lg mb-4">åª’é«”åº«æ˜¯ç©ºçš„</p>
              <button
                onClick={() => fileInputRef.current?.click()}
                className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
              >
                é–‹å§‹ä¸Šå‚³åª’é«”æª”æ¡ˆ
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // ç·¨è¼¯é é¢
  if (currentPage === 'settings' && currentProject) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-5xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <button onClick={() => setCurrentPage('projects')} className="text-blue-600 hover:text-blue-700 font-semibold mb-2">
                â† å›åˆ°å°ˆæ¡ˆåˆ—è¡¨
              </button>
              <h1 className="text-3xl font-bold text-slate-800">{currentProject.name}</h1>
            </div>
            <div className="flex gap-2">
              {syncStatus && (
                <div className="px-3 py-2 bg-white rounded-lg shadow-sm text-sm font-medium">
                  {syncStatus}
                </div>
              )}
              <button
                onClick={saveToCloud}
                disabled={isSaving}
                className={`px-4 py-2 rounded-lg font-semibold shadow-sm transition ${
                  isSaving
                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed'
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
              >
                {isSaving ? 'å„²å­˜ä¸­...' : 'ğŸ’¾ å„²å­˜åˆ°é›²ç«¯'}
              </button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">æ–°å¢ç« ç¯€</h2>
            <div className="flex gap-2">
              <input
                type="text"
                value={newChapterName}
                onChange={(e) => setNewChapterName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addChapter()}
                placeholder="è¼¸å…¥ç« ç¯€åç¨±"
                className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button onClick={addChapter} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                æ–°å¢ç« ç¯€
              </button>
            </div>
          </div>

          <div className="space-y-6">
            {currentProject.chapters.map((chapter, chapterIndex) => (
              <div key={chapter.id} className="bg-white rounded-lg shadow-sm p-6">
                <div className="flex items-center justify-between mb-4">
                  <input
                    type="text"
                    value={chapter.name}
                    onChange={(e) => updateChapterName(chapter.id, e.target.value)}
                    className="text-xl font-semibold px-2 py-1 border-b-2 border-transparent focus:border-blue-500 focus:outline-none"
                  />
                  <div className="flex gap-2">
                    <button
                      onClick={() => moveChapter(chapterIndex, 'up')}
                      disabled={chapterIndex === 0}
                      className={`px-3 py-1 rounded-lg ${chapterIndex === 0 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                    >
                      â†‘
                    </button>
                    <button
                      onClick={() => moveChapter(chapterIndex, 'down')}
                      disabled={chapterIndex === currentProject.chapters.length - 1}
                      className={`px-3 py-1 rounded-lg ${chapterIndex === currentProject.chapters.length - 1 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                    >
                      â†“
                    </button>
                    <button onClick={() => deleteChapter(chapter.id)} className="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700">
                      ğŸ—‘ï¸ åˆªé™¤ç« ç¯€
                    </button>
                  </div>
                </div>

                <div className="space-y-3 mb-4">
                  {chapter.sections.map((section, sectionIndex) => (
                    <div key={section.id} className="border-2 border-slate-200 rounded-lg p-4">
                      <div className="flex items-start gap-3 mb-3">
                        <div className="flex flex-col gap-1">
                          <button
                            onClick={() => moveSection(chapter.id, sectionIndex, 'up')}
                            disabled={sectionIndex === 0}
                            className={`px-2 py-1 rounded ${sectionIndex === 0 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                          >
                            â†‘
                          </button>
                          <button
                            onClick={() => moveSection(chapter.id, sectionIndex, 'down')}
                            disabled={sectionIndex === chapter.sections.length - 1}
                            className={`px-2 py-1 rounded ${sectionIndex === chapter.sections.length - 1 ? 'bg-slate-200 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-700'}`}
                          >
                            â†“
                          </button>
                        </div>
                        <div className="flex-1">
                          <input
                            type="text"
                            value={section.name}
                            onChange={(e) => updateSectionName(chapter.id, section.id, e.target.value)}
                            placeholder="æ®µè½åç¨±"
                            className="w-full px-3 py-2 border border-slate-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <input
                            type="text"
                            value={section.cue}
                            onChange={(e) => updateSectionCue(chapter.id, section.id, e.target.value)}
                            placeholder="Cue é»"
                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <div className="mt-2 flex items-center gap-2">
                            <button
                              onClick={() => openMediaSelector(chapter.id, section.id)}
                              className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                            >
                              ğŸµ å¾åª’é«”åº«é¸æ“‡
                            </button>
                            {section.audioFile && (
                              <span className="text-sm text-slate-600">
                                âœ… {section.audioFile}
                              </span>
                            )}
                          </div>
                        </div>
                        <button
                          onClick={() => deleteSection(chapter.id, section.id)}
                          className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                        >
                          ğŸ—‘ï¸
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

                {newChapterId === chapter.id ? (
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newSectionName}
                      onChange={(e) => setNewSectionName(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addSection(chapter.id)}
                      placeholder="è¼¸å…¥æ®µè½åç¨±"
                      className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button onClick={() => addSection(chapter.id)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                      ç¢ºèª
                    </button>
                    <button onClick={() => { setNewChapterId(null); setNewSectionName(''); }} className="px-4 py-2 bg-slate-400 text-white rounded-lg hover:bg-slate-500">
                      å–æ¶ˆ
                    </button>
                  </div>
                ) : (
                  <button onClick={() => setNewChapterId(chapter.id)} className="w-full py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-blue-500 hover:text-blue-600 transition">
                    + æ–°å¢æ®µè½
                  </button>
                )}
              </div>
            ))}
          </div>

          {currentProject.chapters.length === 0 && (
            <div className="text-center text-slate-400 py-12 bg-white rounded-lg">
              <p>é‚„æ²’æœ‰ä»»ä½•ç« ç¯€ï¼Œå¾ä¸Šæ–¹æ–°å¢ç¬¬ä¸€å€‹ç« ç¯€å§ï¼</p>
            </div>
          )}
        </div>

        {showMediaSelector && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
              <div className="p-6 border-b border-slate-200">
                <div className="flex items-center justify-between">
                  <h2 className="text-2xl font-bold text-slate-800">é¸æ“‡åª’é«”æª”æ¡ˆ</h2>
                  <button
                    onClick={() => {
                      setShowMediaSelector(false);
                      setSelectingForSection(null);
                    }}
                    className="text-slate-400 hover:text-slate-600 text-2xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              <div className="p-6 overflow-y-auto max-h-[60vh]">
                {mediaLibrary.length === 0 ? (
                  <div className="text-center py-8">
                    <svg className="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                    <p className="text-slate-500 mb-4">åª’é«”åº«ä¸­æ²’æœ‰ä»»ä½•æª”æ¡ˆ</p>
                    <button
                      onClick={() => {
                        setShowMediaSelector(false);
                        setSelectingForSection(null);
                        setCurrentPage('media');
                      }}
                      className="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                    >
                      å‰å¾€åª’é«”åº«ä¸Šå‚³
                    </button>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 gap-3">
                    {mediaLibrary.map(media => (
                      <button
                        key={media.id}
                        onClick={() => selectMediaForSection(selectingForSection.chapterId, selectingForSection.sectionId, media)}
                        className="flex items-center gap-3 p-4 border-2 border-slate-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition text-left"
                      >
                        <div className="flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                          <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                          </svg>
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-slate-800 truncate">{media.name}</p>
                          <p className="text-xs text-slate-500">{new Date(media.uploadDate).toLocaleDateString('zh-TW')}</p>
                        </div>
                        <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // æ’­æ”¾é é¢
  if (currentPage === 'play' && currentProject) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
        <div className="max-w-5xl mx-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <button onClick={() => setCurrentPage('projects')} className="text-blue-600 hover:text-blue-700 font-semibold mb-2">â† å›åˆ°å°ˆæ¡ˆåˆ—è¡¨</button>
              <h1 className="text-3xl font-bold text-slate-800">{currentProject.name}</h1>
            </div>
            <button 
              onClick={() => setCurrentPage('settings')} 
              className="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50"
            >
              âœï¸ ç·¨è¼¯å°ˆæ¡ˆ
            </button>
          </div>

          <div className="space-y-6 mb-20">
            {currentProject.chapters.map(chapter => (
              <div key={chapter.id} className="bg-white rounded-lg shadow-sm p-6">
                <h2 className="text-xl font-semibold mb-4">{chapter.name}</h2>
                <div className="space-y-3">
                  {chapter.sections.map(section => {
                    const isPlaying = currentPlayingId === section.id && !isPaused;
                    const isPausedState = currentPlayingId === section.id && isPaused;
                    return (
                      <div key={section.id} className={`border-2 rounded-lg p-4 transition ${isPlaying ? 'border-blue-500 bg-blue-50' : isPausedState ? 'border-yellow-500 bg-yellow-50' : 'border-slate-200'}`}>
                        <div className="flex items-start gap-3">
                          <button
                            onClick={() => togglePlaySection(section, section.id)}
                            disabled={!section.audioData}
                            className={`flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center ${
                              !section.audioData
                                ? 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                : isPlaying
                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                : isPausedState
                                ? 'bg-yellow-600 text-white hover:bg-yellow-700'
                                : 'bg-slate-700 text-white hover:bg-slate-800'
                            }`}
                          >
                            {isPlaying ? (
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                              </svg>
                            ) : (
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                              </svg>
                            )}
                          </button>
                          <div className="flex-1">
                            <p className="font-semibold text-slate-800 mb-1">{section.name}</p>
                            {section.cue && <p className="text-sm text-slate-600 mb-1">{section.cue}</p>}
                            <p className="text-xs text-slate-500">
                              {section.audioFile ? 'ğŸµ ' + section.audioFile : 'âš ï¸ æœªä¸Šå‚³éŸ³æª”'}
                            </p>
                            {(isPlaying || isPausedState) && (
                              <div className="mt-3 flex items-center gap-2">
                                <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full ${isPlaying ? 'bg-blue-600' : 'bg-yellow-600'}`}
                                    style={{ width: duration > 0 ? `${(currentTime / duration) * 100}%` : '0%', transition: 'width 0.1s' }} 
                                  />
                                </div>
                                <span className="text-xs text-slate-600 font-medium w-12 text-right">
                                  {Math.floor(currentTime)}s / {Math.floor(duration)}s
                                </span>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>

          {currentProject.chapters.length === 0 && (
            <div className="text-center text-slate-400 py-12 bg-white rounded-lg">
              <p>é‚„æ²’æœ‰ä»»ä½•ç« ç¯€æˆ–æ®µè½</p>
              <button 
                onClick={() => setCurrentPage('settings')}
                className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                å‰å¾€ç·¨è¼¯
              </button>
            </div>
          )}

          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-lg">
            <div className="max-w-5xl mx-auto flex items-center gap-4">
              <svg className="w-5 h-5 text-slate-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
              </svg>
              <input
                type="range"
                min="0"
                max="1"
                step="0.01"
                value={volume}
                onChange={(e) => {
                  const newVol = parseFloat(e.target.value);
                  setVolume(newVol);
                  if (audioRef.current) audioRef.current.volume = newVol;
                }}
                className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                style={{
                  background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${volume * 100}%, #e2e8f0 ${volume * 100}%, #e2e8f0 100%)`
                }}
              />
              <span className="text-sm text-slate-600 font-medium w-12 text-right">{Math.round(volume * 100)}%</span>
            </div>
          </div>
        </div>

        <audio
          ref={audioRef}
          onEnded={() => {
            setCurrentPlayingId(null);
            setIsPaused(false);
          }}
          onTimeUpdate={(e) => setCurrentTime(e.target.currentTime)}
          onLoadedMetadata={(e) => setDuration(e.target.duration)}
        />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
      <div className="text-center">
        <p className="text-slate-600">è«‹é¸æ“‡å°ˆæ¡ˆ</p>
        <button onClick={() => setCurrentPage('projects')} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          å›åˆ°å°ˆæ¡ˆåˆ—è¡¨
        </button>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<TheaterApp />);
</script>
</body>
</html>
